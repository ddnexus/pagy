#!/usr/bin/env ruby
# frozen_string_literal: true

VERSION = '43.2.1'
LINUX   = RbConfig::CONFIG['host_os'].include?('linux')
HOST    = 'localhost'
PORT    = '8000'

require 'optparse' # Standard library, no extra gems
require_relative '../lib/pagy'
require_relative '../apps/index'

# Default configuration
apps    = PagyApps::INDEX
options = { env:   'development',
            host:  HOST,
            port:  PORT,
            rerun: false,
            clear: false,
            quiet: false }

# Define the parser
parser = OptionParser.new do |opts|
  opts.banner = <<~BANNER
    Pagy #{VERSION} (https://ddnexus.github.io/pagy/playground)
    Playground to showcase, clone and develop Pagy APPs

    Usage:
      pagy APP [opts]    Showcase APP from the installed gem
      pagy clone APP     Clone APP to the current dir
      pagy FILE [opts]   Develop app FILE from local path
  BANNER

  opts.summary_indent = '  '
  opts.summary_width  = 18

  opts.separator "\nAPPs"
  apps.each do |name, path|
    desc = File.readlines(path)[3].sub('#    ', '').strip
    opts.separator "   #{name.ljust(18)}#{desc}"
  end

  opts.separator "\nRackup options"
  opts.on('-e', '--env ENV', 'Environment') { |v| options[:env] = v }
  opts.on('-o', '--host HOST', 'Host')      { |v| options[:host] = v }
  opts.on('-p', '--port PORT', 'Port')      { |v| options[:port] = v }

  if LINUX
    opts.separator "\nRerun options"
    opts.on('--rerun', 'Enable rerun for development') { options[:rerun] = true }
    opts.on('--clear', 'Clear screen before each rerun') { options[:clear] = true }
  end

  opts.separator "\nOther options"
  opts.on('-q', '--quiet', 'Quiet mode for development') { options[:quiet] = true }
  opts.on('-v', '--version', 'Show version') do
    puts VERSION
    exit
  end

  opts.on('-h', '--help', 'Show this help') do
    puts opts
    exit
  end

  opts.separator "\nExamples"
  opts.separator "  pagy demo          Showcase demo at http://#{HOST}:#{PORT}"
  opts.separator '  pagy clone repro   Clone repro to ./repro.ru (rename it)'
  opts.separator "  pagy ~/myapp.ru    Develop ~/myapp.ru at #{HOST}:#{PORT}"
end

# Parse ARGV (removes flags from ARGV, leaving positional args)
begin
  parser.parse!
rescue OptionParser::InvalidOption => e
  abort e.message
end

# Show help if no arguments provided
if ARGV.empty?
  puts parser
  exit
end

run_from_repo = Pagy::ROOT.join('pagy.gemspec').exist?

# Bundle
require 'bundler/inline'
gemfile(!run_from_repo) do
  source 'https://rubygems.org'
  gem 'logger'
  gem 'rackup'
  gem 'rerun' if LINUX
end

arg = ARGV.shift
if arg.eql?('clone')
  name = ARGV.shift
  abort "Expected APP to be in [#{apps.keys.join(', ')}]; got #{name.inspect}" unless apps.key?(name)
  if File.exist?(name)
    print "Do you want to overwrite the #{name.inspect} file? (y/n)> "
    answer = gets.chomp
    abort "#{name.inspect} file already present" unless answer.start_with?(/y/i)
  end
  require 'fileutils'
  FileUtils.cp(apps[name], '.', verbose: true)
else
  if apps.key?(arg) # showcase env
    options[:env]   = 'showcase'
    options[:rerun] = false
    options[:quiet] = true
    # Avoid the creation of './tmp/local_secret.txt' for showcase env
    ENV['SECRET_KEY_BASE'] = 'absolute secret!' if arg.eql?('rails')
    file = apps[arg]
  else # development env
    file = arg
  end
  abort "#{file.inspect} app not found" unless File.exist?(file)

  # Run command
  gem_dir = File.expand_path('..', __dir__)
  # NOTE: mapped options[:key] instead of opts[:key]
  rackup  = "rackup -I #{gem_dir}/lib -r pagy -o #{options[:host]} -p #{options[:port]} -E #{options[:env]} #{file}"
  rackup << ' -q' if options[:quiet]
  if options[:rerun]
    name  = File.basename(file)
    dir   = File.dirname(file)
    rerun = if run_from_repo # rerun app also when gem dir files change (for pagy devs)
              "rerun --name #{name} -d #{dir},#{gem_dir} -p **/*.{rb,js,css,scss,ru,yml}"
            else
              "rerun --name #{name} -d #{dir} -p #{name}" # rerun only when app.ru changes
            end
    rerun << ' -q' if options[:quiet]
    rerun << ' -c' if options[:clear]
    rerun << " -- #{rackup}"
  end
  exec(rerun || rackup)
end
