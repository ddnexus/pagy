#!/usr/bin/env bash

set -e

# Parse args to handle -a flag
args=()
all_output=false
for arg in "$@"; do
	if [[ "$arg" == "-a" ]]; then
		all_output=true
	else
		args+=("$arg")
	fi
done

set -- "${args[@]}"

app=$1
port=${2:-8080}

root="$(git rev-parse --show-toplevel)"
. "$root/scripts/cd-and-back.sh"
cd "$root/e2e"

filter_output() {
	if [[ "$all_output" == "true" ]]; then
		cat
	else
		grep -v -e "starting server using command" \
		        -e "is responding with HTTP status code" \
		        -e "running tests using command" \
		        -e "DevTools listening on" | awk 'NF' || true
	fi
}

test () {
	NODE_NO_WARNINGS=1 FORCE_COLOR=1 \
	bun run start-test "CY_TEST=true bundle exec $root/gem/bin/pagy $app -p $port -q > /dev/null" "http://0.0.0.0:$port" \
	                   "cypress run --quiet --config baseUrl=http://127.0.0.1:$port --spec cypress/e2e/$app.cy.ts"
}

if [[ -z $app ]]
then
	pids=()
	tmps=()
	apps=()

	for app in demo repro rails calendar keynav
	do
		port=$((port+1))
		tmp=$(mktemp)
		tmps+=("$tmp")
		apps+=("$app")
		( test > "$tmp" 2>&1; echo $? > "$tmp.exit" ) &
		pids+=($!)
	done

	spin='-\|/'
	i=0
	fail=0

	while [ ${#pids[@]} -gt 0 ]; do
		i=$(( (i+1) %4 ))
		printf "\r%s\033[K" "${spin:$i:1}"

		for idx in "${!pids[@]}"; do
			tmp=${tmps[$idx]}
			if [[ -f "$tmp.exit" ]]; then
				pid=${pids[$idx]}
				wait "$pid" || true
				code=$(cat "$tmp.exit")
				rm "$tmp.exit"

				if [ "$code" -ne 0 ]; then fail=1; fi

				printf "\r\033[K"
				echo -n "--------------------------------------------------"
				cat "$tmp" | filter_output

				rm "$tmp"
				unset 'pids[$idx]'
				unset 'tmps[$idx]'
				unset 'apps[$idx]'
			fi
		done
		sleep 0.2
	done
	printf "\r\033[K"

	[[ $fail -eq 0 ]] || exit 1
else
	echo ">>> Output for $app:"
	set -o pipefail
	test | filter_output
fi
