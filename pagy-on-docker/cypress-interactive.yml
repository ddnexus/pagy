# Integration interactive test cypress mode

# USAGE
#   cd pagy-on-docker
#   docker-compose -f docker-compose.yml -f cypress-headless -f cypress-interactive.yml up pagy pagy-cypress

# HEADLESS - run from the container:
#   cypress run
# or

# INTERACTIVE - run from the container:
#   cypress open --project /e2e

# IMPORTANT: you may have to edit the volume mounts in order to match your host OS
version: "3.8"

services:

  pagy-cypress:
    environment:
      - CYPRESS_baseUrl=http://0.0.0.0:4567
      - DISPLAY
      - DBUS_SESSION_BUS_ADDRESS
    privileged: true
    network_mode: host
    volumes:
      - cypress_user_home:/home/node
      # mounts working on ubuntu 20.10 host uid 1000
      - /run/user/1000/bus:/run/user/1000/bus
      - /var/run/dbus/system_bus_socket:/var/run/dbus/system_bus_socket
      # node is the user name for uid 1000: for other cases use your actual USER
      - cypress_config:/home/node/.config
      # you may need to change all these mounts by reading at the error messages in the container
      # you might also need some of the following:
      # - $XAUTHORITY:/root/.Xauthority:rw
      # - $HOME/.Xauthority:/root/.Xauthority:rw
      # or on macOS:
      # - /tmp/.X11-unix:/tmp/.X11-unix
    command: /bin/sh -c "while sleep 1000; do :; done"
    entrypoint: []
    stdin_open: true
    tty: true

volumes:
  # persists the configuration settings and the user home
  cypress_config:
    name: pagy_cypress_config
  cypress_user_home:
    name: pagy_cypress_user_home
